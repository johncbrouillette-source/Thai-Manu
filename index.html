<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Pedido de Comida Tailandesa</title>
<style>
  :root{
    --bg:#000;
    --card:#1a1a1a;
    --muted:#2a2a2a;
    --accent:#e74c3c;
    --ok:#28a745;
    --ok-hover:#218838;
    --warn:#ffcc00;
  }
  body { 
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    background: var(--bg);
    color: white;
    margin: 0;
    padding: 20px;
  }
  .container {
    max-width: 520px;
    margin: 0 auto;
    background: var(--card);
    padding: 20px;
    border-radius: 12px;
    box-shadow: 0 10px 30px rgba(0,0,0,.4);
  }
  .logo {
    display: block;
    margin: 0 auto 16px;
    max-width: 150px;
    height: auto;
  }
  h1 {
    text-align: center;
    margin: 0 0 18px;
    color: var(--accent);
    font-size: 22px;
  }
  .delivery-section, .customer-section {
    margin-bottom: 18px;
  }
  label {
    display: block;
    margin: 10px 0 6px;
    font-weight: 700;
    font-size: 14px;
  }
  input, select {
    width: 100%;
    padding: 10px 12px;
    border-radius: 6px;
    border: none;
    margin-bottom: 8px;
    font-size: 14px;
    background: #121212;
    color: #fff;
    outline: 1px solid #333;
  }
  input:focus, select:focus { outline: 2px solid #555; }
  .menu-item {
    display: flex;
    align-items: center;
    background: var(--muted);
    padding: 10px;
    border-radius: 8px;
    margin-bottom: 12px;
  }
  .menu-item img {
    width: 60px;
    height: 60px;
    border-radius: 6px;
    margin-right: 12px;
    object-fit: cover;
  }
  .menu-item label {
    flex: 1;
    color: white;
    margin: 0;
    font-weight: 600;
  }
  .menu-item input[type="number"] {
    width: 70px;
    padding: 8px;
    text-align: center;
    font-weight: bold;
    background:#111;
    color:#fff;
    outline:1px solid #333;
    border-radius:6px;
  }
  .totals {
    margin: 10px 0 16px;
    padding: 10px 12px;
    background:#111;
    border:1px solid #333;
    border-radius:8px;
    display:flex;
    justify-content:space-between;
    align-items:center;
    font-weight:700;
  }
  .next-day-alert {
    color: var(--warn);
    font-size: 13px;
    margin-top: -2px;
    margin-bottom: 8px;
  }
  .btn {
    width: 100%;
    padding: 12px;
    background: var(--ok);
    border: none;
    color: white;
    font-size: 16px;
    border-radius: 8px;
    cursor: pointer;
    font-weight:700;
  }
  .btn:hover { background: var(--ok-hover); }

  /* Modal */
  .modal-backdrop{
    position:fixed; inset:0;
    background: rgba(0,0,0,.6);
    display:none;
    align-items:center;
    justify-content:center;
    padding:16px;
    z-index: 9999;
  }
  .modal{
    width: 100%;
    max-width: 520px;
    background: #121212;
    color:#fff;
    border-radius:12px;
    box-shadow: 0 20px 60px rgba(0,0,0,.6);
    overflow:hidden;
  }
  .modal-header{
    padding:14px 16px;
    background:#181818;
    border-bottom:1px solid #2a2a2a;
    display:flex; justify-content:space-between; align-items:center;
  }
  .modal-title{ font-weight:800; color:#fff; }
  .modal-body{
    padding:16px;
    max-height: 70vh;
    overflow:auto;
  }
  .order-list{ list-style:none; padding:0; margin:0 0 12px; }
  .order-line{
    display:flex; justify-content:space-between; align-items:center;
    padding:8px 10px; border-bottom:1px dashed #2a2a2a; font-size:14px;
  }
  .modal-footer{
    display:flex; gap:8px; padding:14px 16px; background:#181818; border-top:1px solid #2a2a2a;
  }
  .btn-ghost{
    flex:1;
    background:#2a2a2a; color:#fff; border:none; border-radius:8px; padding:12px; cursor:pointer; font-weight:700;
  }
  .btn-primary{
    flex:1;
    background: var(--ok); color:#fff; border:none; border-radius:8px; padding:12px; cursor:pointer; font-weight:700;
  }
  .btn-primary[disabled]{ opacity:.7; cursor:not-allowed; }
  .spinner{
    display:inline-block; width:16px; height:16px; border:2px solid rgba(255,255,255,.35);
    border-top-color:#fff; border-radius:50%; animation:spin 1s linear infinite; vertical-align:-3px; margin-right:8px;
  }
  @keyframes spin{ to{ transform: rotate(360deg); } }

  /* Help text under phone, small */
  .hint { font-size:12px; color:#aaa; margin-top:-6px; margin-bottom:8px; }
</style>
</head>
<body>

<div class="container">
  <img src="https://raw.githubusercontent.com/khaoniaobistro/Thai-Manu/main/khao%20logo.png" alt="Logo" class="logo">
  <h1>Men√∫ Tailand√©s</h1>

  <div class="delivery-section">
    <label for="deliveryDate">Fecha del Pedido:</label>
    <input type="date" id="deliveryDate" aria-describedby="nextDayAlert">
    <div id="nextDayAlert" class="next-day-alert" style="display:none;">
      üìÖ Este pedido ser√° entregado ma√±ana - o seleccione otra fecha.
    </div>

    <label for="casa">Casa #:</label>
    <input type="text" id="casa" inputmode="numeric" placeholder="Ej: 23">

    <label for="deliveryTime">Hora de Entrega:</label>
    <select id="deliveryTime">
      <option value="">--Seleccionar--</option>
      <option>11:00</option>
      <option>11:30</option>
      <option>12:00</option>
      <option>12:30</option>
      <option>13:00</option>
    </select>
  </div>

  <div id="menu">
    <div class="menu-item">
      <img src="https://raw.githubusercontent.com/khaoniaobistro/Thai-Manu/main/padthai.jpeg" alt="Pad Thai">
      <label>Pad Thai - $20.000 COP</label>
      <input type="number" min="0" value="0" data-name="Pad Thai" data-price="20000">
    </div>
    <div class="menu-item">
      <img src="https://raw.githubusercontent.com/khaoniaobistro/Thai-Manu/main/rice.jpeg" alt="Arroz Thai">
      <label>Arroz Thai - $19.000 COP</label>
      <input type="number" min="0" value="0" data-name="Arroz Thai" data-price="19000">
    </div>
    <div class="menu-item">
      <img src="https://raw.githubusercontent.com/khaoniaobistro/Thai-Manu/main/padcombo.png" alt="Combo Pad Thai">
      <label>Combo Pad Thai - $26.000 COP</label>
      <input type="number" min="0" value="0" data-name="Combo Pad Thai" data-price="26000">
    </div>
    <div class="menu-item">
      <img src="https://raw.githubusercontent.com/khaoniaobistro/Thai-Manu/main/ricecombo.png" alt="Combo Arroz Thai">
      <label>Combo Arroz Thai - $25.000 COP</label>
      <input type="number" min="0" value="0" data-name="Combo Arroz Thai" data-price="25000">
    </div>
  </div>

  <div class="totals">
    <span>Total estimado</span>
    <strong id="runningTotal">COP $0</strong>
  </div>

  <div class="customer-section">
    <label>Nombre Completo:</label>
    <input type="text" id="name" placeholder="Nombre y apellido">
    <label>WhatsApp:</label>
    <input type="text" id="phone" placeholder="+57 300 000 0000">
    <div class="hint">Usaremos este n√∫mero para confirmar tu pedido por WhatsApp.</div>
    <label>Notas:</label>
    <input type="text" id="notes" placeholder="Sin cilantro, extra picante, etc.">
  </div>

  <button class="btn" id="openSummaryBtn">Enviar Pedido</button>
</div>

<!-- Summary Modal -->
<div class="modal-backdrop" id="summaryBackdrop" aria-hidden="true">
  <div class="modal" role="dialog" aria-labelledby="summaryTitle" aria-modal="true">
    <div class="modal-header">
      <div class="modal-title" id="summaryTitle">Resumen de pedido</div>
      <button class="btn-ghost" id="closeSummaryTop" aria-label="Cerrar">‚úï</button>
    </div>
    <div class="modal-body">
      <div id="summaryMeta" style="margin-bottom:10px; font-size:14px; color:#ddd;"></div>
      <ul class="order-list" id="summaryList"></ul>
      <div class="totals">
        <span>Total</span>
        <strong id="summaryTotal">COP $0</strong>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn-ghost" id="editOrderBtn">Editar</button>
      <button class="btn-primary" id="confirmOrderBtn">Confirmar Pedido</button>
    </div>
  </div>
</div>

<script>
const APPS_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbyDcQIS3wpF-5aCSOns7ufnn4bWVlqv8dlpB5AUCv_oFNvUZwqCnXoBmNLEbk-nCmEMoA/exec";

/* ========== Utilities ========== */
const fmtCOP = (n) => new Intl.NumberFormat('es-CO', { style: 'currency', currency: 'COP', maximumFractionDigits: 0 }).format(Math.round(n || 0));
function getColombiaNow(){
  const now = new Date();
  const tz = { timeZone: "America/Bogota" };
  return new Date(now.toLocaleString("en-US", tz));
}
function setDeliveryDateDefault(){
  const nowCo = getColombiaNow();
  const h = nowCo.getHours(), m = nowCo.getMinutes();
  const alertEl = document.getElementById("nextDayAlert");

  // Before 12:30 -> same day. At 12:31 or later -> next day.
  if (h > 12 || (h === 12 && m >= 31)) {
    nowCo.setDate(nowCo.getDate() + 1);
    alertEl.style.display = "block";
  } else {
    alertEl.style.display = "none";
  }
  document.getElementById("deliveryDate").value = nowCo.toISOString().split("T")[0];
}
function recalcTotal(){
  let subtotal = 0;
  document.querySelectorAll("#menu input[type='number']").forEach(inp=>{
    const qty = parseInt(inp.value,10) || 0;
    const price = parseFloat(inp.dataset.price) || 0;
    subtotal += qty * price;
  });
  document.getElementById("runningTotal").textContent = fmtCOP(subtotal);
  return subtotal;
}
function collectItems(){
  const items = [];
  document.querySelectorAll("#menu input[type='number']").forEach(inp=>{
    const qty = parseInt(inp.value,10) || 0;
    if (qty>0){
      items.push({
        name: inp.dataset.name,
        price: parseFloat(inp.dataset.price) || 0,
        quantity: qty
      });
    }
  });
  return items;
}

/* ========== Summary Modal Logic ========== */
const backdrop = document.getElementById("summaryBackdrop");
const openSummaryBtn = document.getElementById("openSummaryBtn");
const closeSummaryTop = document.getElementById("closeSummaryTop");
const editOrderBtn = document.getElementById("editOrderBtn");
const confirmOrderBtn = document.getElementById("confirmOrderBtn");
const summaryList = document.getElementById("summaryList");
const summaryTotalEl = document.getElementById("summaryTotal");
const summaryMeta = document.getElementById("summaryMeta");

function showSummary(){
  // Validate required fields before showing summary
  const deliveryDate = document.getElementById("deliveryDate").value;
  const name = document.getElementById("name").value.trim();
  const phone = document.getElementById("phone").value.trim();
  const items = collectItems();

  if (!deliveryDate || !name || !phone || items.length === 0) {
    alert("Por favor complete la fecha, nombre, n√∫mero de WhatsApp y seleccione al menos un producto.");
    return;
  }

  // Build summary list
  summaryList.innerHTML = "";
  let subtotal = 0;
  items.forEach(i=>{
    const line = i.price * i.quantity;
    subtotal += line;
    const li = document.createElement("li");
    li.className = "order-line";
    li.innerHTML = `<span>${i.name} √ó ${i.quantity}</span><strong>${fmtCOP(line)}</strong>`;
    summaryList.appendChild(li);
  });
  summaryTotalEl.textContent = fmtCOP(subtotal);

  // Meta (date, time, casa)
  const casa = (document.getElementById("casa").value || '').trim();
  const time = (document.getElementById("deliveryTime").value || '').trim();
  const datePretty = new Date(document.getElementById("deliveryDate").value + "T00:00:00").toLocaleDateString('es-CO', { timeZone:'America/Bogota' });
  summaryMeta.textContent = `Entrega: ${datePretty}${time ? " ¬∑ " + time : ""}${casa ? " ¬∑ Casa " + casa : ""}`;

  // Show modal
  backdrop.style.display = "flex";
  backdrop.setAttribute("aria-hidden","false");
}
function hideSummary(){
  backdrop.style.display = "none";
  backdrop.setAttribute("aria-hidden","true");
}

openSummaryBtn.addEventListener("click", showSummary);
closeSummaryTop.addEventListener("click", hideSummary);
editOrderBtn.addEventListener("click", hideSummary);
backdrop.addEventListener("click", (e)=>{ if(e.target === backdrop) hideSummary(); });

/* ========== Submit Flow with Spinner ========== */
async function submitOrder(){
  const deliveryDate = document.getElementById("deliveryDate").value;
  const casa = document.getElementById("casa").value.trim();
  const deliveryTime = document.getElementById("deliveryTime").value.trim();
  const name = document.getElementById("name").value.trim();
  const phone = document.getElementById("phone").value.trim();
  const notes = document.getElementById("notes").value.trim();

  const items = collectItems();
  let totalQty = items.reduce((s,i)=> s + (parseInt(i.quantity,10)||0), 0);
  let subtotal = items.reduce((s,i)=> s + ((parseFloat(i.price)||0)*(parseInt(i.quantity,10)||0)), 0);

  const orderData = {
    deliveryDate,
    casa,
    deliveryTime,
    name,
    phone,
    notes,
    items,
    order: items.map(i => i.name).join(', '),
    quantity: totalQty,
    subtotal: subtotal
  };

  // Loading state
  confirmOrderBtn.disabled = true;
  const originalConfirmText = confirmOrderBtn.textContent;
  confirmOrderBtn.innerHTML = `<span class="spinner"></span> Enviando‚Ä¶`;

  try {
    await fetch(APPS_SCRIPT_URL, {
      method: "POST",
      mode: "no-cors",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(orderData)
    });

    // Success UX
    hideSummary();
    alert("‚úÖ Pedido enviado con √©xito. ¬°Gracias!");

    // Reset form
    document.querySelectorAll("#menu input[type='number']").forEach(inp=> inp.value = 0);
    document.getElementById("casa").value = "";
    document.getElementById("deliveryTime").value = "";
    document.getElementById("name").value = "";
    document.getElementById("phone").value = "";
    document.getElementById("notes").value = "";
    setDeliveryDateDefault();
    recalcTotal();

  } catch (err) {
    alert("‚ùå Hubo un error al enviar el pedido. Int√©ntelo de nuevo.");
  } finally {
    confirmOrderBtn.disabled = false;
    confirmOrderBtn.textContent = originalConfirmText;
  }
}

confirmOrderBtn.addEventListener("click", submitOrder);

/* ========== Init & Live Total ========== */
setDeliveryDateDefault();
recalcTotal();

// Update alert visibility if user manually changes date
document.getElementById("deliveryDate").addEventListener("change", ()=>{
  const todayCo = getColombiaNow();
  const chosen = new Date(document.getElementById("deliveryDate").value + "T00:00:00");
  const todayYmd = todayCo.toISOString().split("T")[0];
  const chosenYmd = chosen.toISOString().split("T")[0];
  document.getElementById("nextDayAlert").style.display = (chosenYmd > todayYmd) ? "block" : "none";
});

// Recalc total on any quantity change
document.querySelectorAll("#menu input[type='number']").forEach(inp=>{
  inp.addEventListener("input", recalcTotal);
});
</script>
</body>
</html>
