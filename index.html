<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Pedido de Comida Tailandesa</title>

<!-- Google Fonts -->
<link href="https://fonts.googleapis.com/css2?family=Open+Sans&display=swap" rel="stylesheet">

<style>
  :root{
    --bg:#000;
    --card:#1a1a1a;
    --card2:#2a2a2a;
    --text:#fff;
    --accent:#28a745;
    --accent-2:#218838;
    --warn:#ffcc00;
    --gold:#FFD700;
    --muted:#888;
    --btn-gray:#444;
  }
  *{box-sizing:border-box}
  body { 
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    background: var(--bg);
    color: var(--text);
    margin: 0;
    padding: 20px;
  }
  .container {
    max-width: 520px;
    margin: 0 auto;
    background: var(--card);
    padding: 20px;
    border-radius: 12px;
  }
  .logo {
    display: block;
    margin: 0 auto 20px;
    max-width: 150px;
  }
  h1 {
    text-align: center;
    margin-bottom: 20px;
    color: var(--gold);
    font-family: 'Open Sans', sans-serif;
  }
  .delivery-section, .customer-section {
    margin-bottom: 20px;
  }
  label {
    display: block;
    margin: 8px 0 6px;
    font-weight: bold;
  }
  input, select, textarea {
    width: 100%;
    padding: 10px;
    border-radius: 8px;
    border: none;
    margin-bottom: 10px;
    font-size: 14px;
    background:#111;
    color: var(--text);
  }
  textarea { resize: vertical; min-height: 44px; }
  .next-day-alert {
    color: var(--warn);
    font-size: 13px;
    margin-top: -5px;
    margin-bottom: 10px;
  }

  /* Menu items */
  .menu-item {
    display: flex;
    align-items: center;
    background: var(--card2);
    padding: 10px;
    border-radius: 10px;
    margin-bottom: 12px;
    gap: 10px;
  }
  .menu-item img {
    width: 60px;
    height: 60px;
    border-radius: 8px;
    object-fit: cover;
    flex-shrink: 0;
  }
  .menu-item .info {
    flex: 1;
    display: flex;
    align-items: center;
    gap: 10px;
    min-width: 0;
  }
  .menu-item .title {
    flex: 1;
    color: var(--text);
    font-weight: 600;
    font-size: 14px;
  }

  /* Quantity controls */
  .qty {
    display: flex;
    align-items: center;
    gap: 6px;
  }
  .qty button {
    width: 34px;
    height: 34px;
    border-radius: 8px;
    border: none;
    background:#3a3a3a;
    color:#fff;
    font-size: 18px;
    cursor: pointer;
  }
  .qty button:active { transform: translateY(1px); }
  .qty input {
    width: 54px;
    text-align: center;
    font-weight: 700;
    background:#111;
    margin: 0;
  }

  /* Total bar */
  .total-bar{
    background:#111;
    border:1px solid #222;
    border-radius:10px;
    padding:12px 14px;
    display:flex;
    justify-content:space-between;
    align-items:center;
    font-size:16px;
    margin:14px 0 12px;
  }
  .total-bar strong{ font-size:18px; }

  /* Buttons */
  .btn {
    width: 100%;
    padding: 12px;
    background: var(--accent);
    border: none;
    color: white;
    font-size: 16px;
    border-radius: 10px;
    cursor: pointer;
  }
  .btn:hover { background: var(--accent-2); }

  .btn-gray{
    background: var(--btn-gray);
  }
  .btn-gray:hover{
    background:#555;
  }

  /* Summary modal */
  .overlay{
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,0.6);
    display: none;
    align-items: center;
    justify-content: center;
    padding: 20px;
    z-index: 50;
  }
  .overlay.show{ display:flex; }
  .modal{
    width: 100%;
    max-width: 520px;
    background: var(--card);
    border-radius: 14px;
    padding: 16px;
  }
  .modal h2{
    margin: 0 0 10px;
    font-size: 18px;
  }
  .summary-list{
    background:#111;
    border:1px solid #222;
    border-radius:10px;
    padding:10px;
    max-height: 50vh;
    overflow:auto;
  }
  .summary-row{
    display:flex;
    justify-content:space-between;
    padding:6px 0;
    border-bottom:1px dashed #333;
    font-size:14px;
  }
  .summary-row:last-child{ border-bottom:none; }
  .summary-total{
    margin-top:10px;
    display:flex;
    justify-content:space-between;
    font-weight:700;
    font-size:16px;
  }
  .modal-actions{
    display:flex;
    gap:10px;
    margin-top:14px;
  }

  /* Processing overlay (elephant spinner) */
  .processing{
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,0.78);
    display: none;
    align-items: center;
    justify-content: center;
    z-index: 100;
    flex-direction: column;
    text-align:center;
    padding:20px;
  }
  .processing.show{ display:flex; }
  .processing img{
    width: 84px;
    height: 84px;
    animation: spin 1.6s linear infinite;
    margin-bottom: 12px;
    border-radius: 50%;
  }
  .processing .msg{
    font-size: 16px;
    color:#ddd;
  }
  @keyframes spin{
    from{ transform: rotate(0deg); }
    to{ transform: rotate(360deg); }
  }

  .version {
    text-align: center;
    font-size: 12px;
    color: var(--muted);
    margin-top: 16px;
  }
</style>
</head>
<body>

<div class="container">
  <img src="https://github.com/khaoniaobistro/Thai-Manu/blob/main/khao%20logo.png?raw=true" alt="Logo" class="logo">
  <h1>MenÃº TailandÃ©s</h1>

  <div class="delivery-section">
    <label for="deliveryDate">Fecha del Pedido:</label>
    <input type="date" id="deliveryDate">
    <div id="nextDayAlert" class="next-day-alert" style="display:none;">
      ðŸ“… Este pedido serÃ¡ entregado maÃ±ana - o seleccione otra fecha.
    </div>

    <label for="casa">Casa #:</label>
    <input type="text" id="casa" placeholder="Ej: 14B o 7">

    <label for="deliveryTime">Hora de Entrega:</label>
    <select id="deliveryTime">
      <option value="">--Seleccionar--</option>
      <option>11:00</option>
      <option>11:30</option>
      <option>12:00</option>
      <option>12:30</option>
      <option>13:00</option>
    </select>
  </div>

  <div id="menu">
    <div class="menu-item">
      <img src="https://github.com/khaoniaobistro/Thai-Manu/blob/main/padthai.jpeg?raw=true" alt="Pad Thai">
      <div class="info">
        <div class="title">Pad Thai - $20.000 COP</div>
        <div class="qty" data-name="Pad Thai" data-price="20000">
          <button type="button" class="btn-minus" aria-label="Disminuir">âˆ’</button>
          <input type="number" min="0" value="0" inputmode="numeric" />
          <button type="button" class="btn-plus" aria-label="Aumentar">+</button>
        </div>
      </div>
    </div>

    <div class="menu-item">
      <img src="https://github.com/khaoniaobistro/Thai-Manu/blob/main/rice.jpeg?raw=true" alt="Arroz Thai">
      <div class="info">
        <div class="title">Arroz Thai - $19.000 COP</div>
        <div class="qty" data-name="Arroz Thai" data-price="19000">
          <button type="button" class="btn-minus" aria-label="Disminuir">âˆ’</button>
          <input type="number" min="0" value="0" inputmode="numeric" />
          <button type="button" class="btn-plus" aria-label="Aumentar">+</button>
        </div>
      </div>
    </div>

    <div class="menu-item">
      <img src="https://github.com/khaoniaobistro/Thai-Manu/blob/main/padcombo.png?raw=true" alt="Combo Pad Thai">
      <div class="info">
        <div class="title">Combo Pad Thai - $26.000 COP</div>
        <div class="qty" data-name="Combo Pad Thai" data-price="26000">
          <button type="button" class="btn-minus" aria-label="Disminuir">âˆ’</button>
          <input type="number" min="0" value="0" inputmode="numeric" />
          <button type="button" class="btn-plus" aria-label="Aumentar">+</button>
        </div>
      </div>
    </div>

    <div class="menu-item">
      <img src="https://github.com/khaoniaobistro/Thai-Manu/blob/main/ricecombo.png?raw=true" alt="Combo Arroz Thai">
      <div class="info">
        <div class="title">Combo Arroz Thai - $25.000 COP</div>
        <div class="qty" data-name="Combo Arroz Thai" data-price="25000">
          <button type="button" class="btn-minus" aria-label="Disminuir">âˆ’</button>
          <input type="number" min="0" value="0" inputmode="numeric" />
          <button type="button" class="btn-plus" aria-label="Aumentar">+</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Live total -->
  <div class="total-bar">
    <span>Total estimado:</span>
    <strong id="totalValue">$0 COP</strong>
  </div>

  <!-- Review button -->
  <button class="btn" id="reviewBtn">Enviar Pedido</button>
  <div class="version">v1.3</div>
</div>

<!-- Order Summary Modal -->
<div class="overlay" id="summaryOverlay" aria-hidden="true">
  <div class="modal" role="dialog" aria-modal="true" aria-labelledby="summaryTitle">
    <h2 id="summaryTitle">Resumen del pedido</h2>
    <div class="summary-list" id="summaryList"></div>
    <div class="summary-total">
      <span>Total</span>
      <span id="summaryTotal">$0 COP</span>
    </div>
    <div class="modal-actions">
      <button type="button" class="btn-gray" id="editBtn">Editar</button>
      <button type="button" class="btn" id="confirmBtn">Confirmar pedido</button>
    </div>
  </div>
</div>

<!-- Processing Overlay (Elephant spinner) -->
<div class="processing" id="processingOverlay" aria-hidden="true">
  <img src="https://github.com/khaoniaobistro/Thai-Manu/blob/main/loading.png?raw=true" alt="Procesando">
  <div class="msg">Procesando pedidoâ€¦</div>
</div>

<script>
const APPS_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbz_fGC8H8BVAHntpui882M4YJBpiKqADRifJnmzSFpcDtrCqOVgSpWTI_mDm2ZvDyhwrQ/exec";

let isSubmitting = false;

/* ---------- Date (BogotÃ¡) & next-day alert ---------- */
function getDefaultDateAndFlag(){
  const now = new Date();
  const col = new Date(now.toLocaleString("en-US", { timeZone: "America/Bogota" }));
  const h = col.getHours();
  const m = col.getMinutes();
  const after1231 = (h > 12) || (h === 12 && m >= 31);
  if (after1231) col.setDate(col.getDate() + 1);
  const iso = col.toISOString().split("T")[0];
  return { iso, after1231 };
}
function setDeliveryDate(){
  const { iso, after1231 } = getDefaultDateAndFlag();
  const alertEl = document.getElementById("nextDayAlert");
  document.getElementById("deliveryDate").value = iso;
  alertEl.style.display = after1231 ? "block" : "none";
}
setDeliveryDate();

// If user changes date, hide the alert unless it matches the default next-day case
document.getElementById("deliveryDate").addEventListener("change", () => {
  const chosen = document.getElementById("deliveryDate").value;
  const def = getDefaultDateAndFlag();
  const alertEl = document.getElementById("nextDayAlert");
  alertEl.style.display = (def.after1231 && chosen === def.iso) ? "block" : "none";
});

/* ---------- Helpers ---------- */
function formatCOP(n){
  return "$" + Number(n || 0).toLocaleString("es-CO") + " COP";
}
function collectItems(){
  const items = [];
  document.querySelectorAll(".qty").forEach(q => {
    const input = q.querySelector("input");
    const qty = parseInt(input.value, 10) || 0;
    if (qty > 0){
      const name = q.dataset.name;
      const price = parseFloat(q.dataset.price);
      items.push({ name, price, quantity: qty });
    }
  });
  return items;
}
function recalcTotal(){
  const items = collectItems();
  const subtotal = items.reduce((s, i) => s + (i.price * i.quantity), 0);
  document.getElementById("totalValue").textContent = formatCOP(subtotal);
}

/* ---------- Quantity controls ---------- */
document.querySelectorAll(".qty").forEach(q => {
  const input = q.querySelector("input");
  q.querySelector(".btn-minus").addEventListener("click", () => {
    const v = Math.max(0, (parseInt(input.value, 10) || 0) - 1);
    input.value = v;
    recalcTotal();
  });
  q.querySelector(".btn-plus").addEventListener("click", () => {
    const v = Math.min(99, (parseInt(input.value, 10) || 0) + 1);
    input.value = v;
    recalcTotal();
  });
  input.addEventListener("input", () => {
    let v = parseInt(input.value, 10);
    if (!Number.isFinite(v) || v < 0) v = 0;
    if (v > 99) v = 99;
    input.value = v;
    recalcTotal();
  });
});
recalcTotal();

/* ---------- Summary modal ---------- */
const summaryOverlay = document.getElementById("summaryOverlay");
const summaryList = document.getElementById("summaryList");
const summaryTotal = document.getElementById("summaryTotal");
const editBtn = document.getElementById("editBtn");
const confirmBtn = document.getElementById("confirmBtn");
const reviewBtn = document.getElementById("reviewBtn");
const processingOverlay = document.getElementById("processingOverlay");

reviewBtn.addEventListener("click", () => {
  // Validate basics before showing summary
  const name = document.getElementById("name").value.trim();
  const phone = document.getElementById("phone").value.trim();
  const deliveryDate = document.getElementById("deliveryDate").value;
  const items = collectItems();

  if (!deliveryDate || !name || !phone || items.length === 0) {
    alert("Por favor complete la fecha, nombre, nÃºmero de WhatsApp y seleccione al menos un producto.");
    return;
  }

  // Build summary
  summaryList.innerHTML = "";
  let subtotal = 0;
  items.forEach(i => {
    const line = i.price * i.quantity;
    subtotal += line;
    const row = document.createElement("div");
    row.className = "summary-row";
    row.innerHTML = `<span>${i.name} Ã— ${i.quantity}</span><span>${formatCOP(line)}</span>`;
    summaryList.appendChild(row);
  });
  summaryTotal.textContent = formatCOP(subtotal);

  summaryOverlay.classList.add("show");
});

editBtn.addEventListener("click", () => {
  summaryOverlay.classList.remove("show");
});

confirmBtn.addEventListener("click", async () => {
  if (isSubmitting) return;
  isSubmitting = true;
  confirmBtn.disabled = true;

  processingOverlay.classList.add("show");
  summaryOverlay.classList.remove("show");

  const deliveryDate = document.getElementById("deliveryDate").value;
  const casa = document.getElementById("casa").value;
  const deliveryTime = document.getElementById("deliveryTime").value;
  const name = document.getElementById("name").value.trim();
  const phone = document.getElementById("phone").value.trim();
  const notes = document.getElementById("notes").value.trim();

  const items = collectItems();
  const totalQty = items.reduce((s,i)=>s+i.quantity,0);
  const subtotal = items.reduce((s,i)=>s+(i.price*i.quantity),0);

  const orderData = {
    deliveryDate,
    casa,
    deliveryTime,
    name,
    phone,
    notes,
    items, // Apps Script uses this to populate Column H correctly
    order: items.map(i => i.name).join(', '),
    quantity: totalQty,
    subtotal: subtotal
  };

  try {
    await fetch(APPS_SCRIPT_URL, {
      method: "POST",
      mode: "no-cors",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(orderData)
    });
    // Success UX
    processingOverlay.classList.remove("show");
    alert("Pedido enviado con Ã©xito. Â¡Gracias!");

    // Reset form
    document.querySelectorAll(".qty input").forEach(i => i.value = 0);
    document.querySelectorAll("input, select, textarea").forEach(el => { if(el.id!=="deliveryDate") el.value = ""; });
    setDeliveryDate();
    recalcTotal();
  } catch (err) {
    processingOverlay.classList.remove("show");
    alert("Hubo un error al enviar el pedido. IntÃ©ntelo de nuevo.");
  } finally {
    isSubmitting = false;
    confirmBtn.disabled = false;
  }
});
</script>
</body>
</html>
